<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.reserve.app.mapper.AdminMapper">

	<select id="getBranchInfo" parameterType="map"  resultType="map">
		SELECT tb_branch_mng.branch_code, branch_name
		FROM tb_branch_mng, tb_user
		WHERE 
			tb_branch_mng.branch_code != 'b0000'
			AND tb_user.user_role like 'SUPERADMIN'
		ORDER BY tb_branch_mng.branch_code
	</select>

	<select id="getUserList" parameterType="map" resultType="map">
		SELECT id, name, phone_number, due_date, hospital, user_role, remark, to_char(created_dt,'YYYY-MM-DD') as created_dt, to_char(modified_dt,'YYYY-MM-DD') as modified_dt, branch_code
		FROM tb_user
		<where>
			user_role like 'USER'
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					and branch_code = #{branch_code}
				</when>
				<otherwise>
					and branch_code = #{super_branch_code}
				</otherwise>
			</choose>
			<if test='userIdOrName != null and userIdOrName != ""'>
				and (
					upper(id) like '%' || upper(#{userIdOrName}) || '%' 
					or upper(name) like '%' || upper(#{userIdOrName}) || '%'
				)
			</if>
			<if test='name!=null and name!=""'>and upper(name) like '%'||upper(#{name})||'%'</if>
			<if test='phoneNumber!=null and phoneNumber!=""'>and phone_number like '%'||upper(#{phoneNumber})||'%'</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				and created_dt BETWEEN to_timestamp(#{startDate}, 'YYYY-MM-DD') AND to_timestamp(#{endDate}, 'YYYY-MM-DD') + INTERVAL '1 day' - INTERVAL '1 second'
			</if>
		</where>
		order by created_dt desc, id asc
	</select>
	
	<update id="resetPassword" parameterType="map">
		update tb_user
		set password = #{user_pw},
			modified_dt = now(),
			modified_id = #{login_id}
		where id = #{user_id}
	</update>
	
	<insert id="addAccount" parameterType="map">
		insert into tb_user (
			id, password, name, phone_number, due_date, hospital, user_role, remark, created_id, created_dt, modified_id, modified_dt, branch_code, user_status
		)
		values (
			#{id}, #{encoded_password}, #{name}, #{phone_number}, #{due_date}, #{hospital}, 'USER', #{remark}, #{login_id}, now(), #{login_id}, now(), #{branch_code}, 'Y'
		)
	</insert>
	
	<update id="updateAccount" parameterType="map">
		update tb_user
		set id = #{id}, 
			name = #{name},
			phone_number = #{phone_number},
			due_date = #{due_date},
			hospital = #{hospital},
			user_status = #{user_status},
			remark = #{remark}, 
			modified_id = #{login_id}, 
			modified_dt = now() 
		where id = #{id}
	</update>

	<select id="checkId" parameterType="map" resultType="int">
		SELECT count(id)
		FROM tb_user
		WHERE 	id = #{add_id}
	</select>
	
	<select id="getBranchList" parameterType="map"  resultType="map">
		SELECT seq_no, branch_code as branch_code_col, branch_name, join_code, to_char(created_dt,'YYYY-MM-DD') as created_dt
		FROM tb_branch_mng
		<where>
			branch_code != 'b0000'
			<if test='branchCode!=null and branchCode!=""'>and branch_code like '%'|| #{branchCode} ||'%'</if>
			<if test='branchName!=null and branchName!=""'>and branch_name like '%'|| #{branchName} ||'%'</if>
			<if test='joinCode!=null and joinCode!=""'>and join_code like '%'|| #{joinCode} ||'%'</if>
		</where>
		ORDER BY branch_code;
	</select>

	<insert id="addBranchInfo" parameterType="map">
		insert into tb_branch_mng (
			branch_code, branch_name, join_code, created_id, created_dt, modified_id, modified_dt
		)
		values (
			#{branch_code_col}, #{branch_name}, #{join_code}, #{login_id}, now(), #{login_id}, now()
		)
	</insert>
	
	<update id="updateBranchInfo" parameterType="map">
		update tb_branch_mng
		set 
			branch_name = #{branch_name},
			modified_id = #{login_id},
			modified_dt = now()
		where seq_no = #{seq_no} and branch_code = #{branch_code_col}
	</update>
	
	<delete id="deleteBranchInfo" parameterType="map">
		delete from tb_branch_mng where seq_no=#{seq_no}
	</delete>

	<select id="getReservationMasterData" parameterType="map"  resultType="map">
		SELECT branch_code, rsv_month, rsv_date, rsv_worker, "1t", "2t", "3t", "4t", "5t", "6t", "7t", "8t", "9t", "10t"
		FROM tb_reservation_master
		<where>
			branch_code like #{branch_code}
			and rsv_month like #{rsv_month}::varchar
		</where>
		ORDER BY rsv_month, rsv_date;
	</select>

<!-- 	<insert id="addReservationMasterData" parameterType="list"> -->
<!-- 		insert into tb_reservation_master ( -->
<!-- 			branch_code, rsv_month, rsv_date,  -->
<!-- 			"1t", "2t", "3t", "4t", "5t",  -->
<!-- 			"6t", "7t", "8t", "9t", "10t",  -->
<!-- 			created_id, created_dt, modified_id, modified_dt -->
<!-- 		) -->
<!-- 		values  -->
<!-- 		<foreach collection="list" item="item" separator=","> -->
<!-- 			( -->
<!-- 				#{branch_code}, #{item.rsv_month}, #{item.rsv_date}, -->
<!-- 				#{item.1t}, #{item.2t}, #{item.3t}, #{item.4t}, #{item.5t}, -->
<!-- 				#{item.6t}, #{item.7t}, #{item.8t}, #{item.9t}, #{item.10t}, -->
<!-- 				#{login_id}, now(), #{login_id}, now() -->
<!-- 			) -->
<!-- 		</foreach> -->
<!-- 	</insert> -->
	<insert id="addReservationMasterData" parameterType="list">
		<foreach collection="list" item="item" separator=";">
			INSERT INTO tb_reservation_master (
				branch_code, rsv_month, rsv_date, rsv_worker, 
				"1t", "2t", "3t", "4t", "5t", 
				"6t", "7t", "8t", "9t", "10t",
				created_id, created_dt, modified_id, modified_dt
			)
			VALUES (
				#{branch_code}, #{item.rsv_month}, #{item.rsv_date}, #{item.rsv_worker}::int,
				#{item.1t}, #{item.2t}, #{item.3t}, #{item.4t}, #{item.5t},
				#{item.6t}, #{item.7t}, #{item.8t}, #{item.9t}, #{item.10t},
				#{login_id}, now(), #{login_id}, now()
			);
			INSERT INTO tb_reservation_count (
				branch_code, rsv_month, rsv_date, 
				"1t_cnt", "2t_cnt", "3t_cnt", "4t_cnt", "5t_cnt", 
				"6t_cnt", "7t_cnt", "8t_cnt", "9t_cnt", "10t_cnt", 
				created_id, created_dt, modified_id, modified_dt
			)
			VALUES (
				#{branch_code}, #{item.rsv_month}, #{item.rsv_date},
				#{item.1t}, #{item.2t}, #{item.3t}, #{item.4t}, #{item.5t},
				#{item.6t}, #{item.7t}, #{item.8t}, #{item.9t}, #{item.10t},
				#{login_id}, now(), #{login_id}, now()
			);
		</foreach>
	</insert>

	
	<delete id="deleteReservationMasterData" parameterType="string">
		delete from tb_reservation_master 
		where branch_code=#{branch_code} and rsv_month=#{stdMonth}
	</delete>
</mapper>