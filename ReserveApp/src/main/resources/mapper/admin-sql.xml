<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.reserve.app.mapper.AdminMapper">

	<select id="getUserList" parameterType="map" resultType="map">
		SELECT id, name, phone_number, due_date, hospital, user_role, remark, to_char(created_dt,'YYYY-MM-DD') as created_dt, 
				to_char(modified_dt,'YYYY-MM-DD') as modified_dt
		FROM tb_user
		<where>
			<if test='userIdOrName != null and userIdOrName != ""'>
				and (
					upper(id) like '%' || upper(#{userIdOrName}) || '%' 
					or upper(name) like '%' || upper(#{userIdOrName}) || '%'
				)
			</if>
			<if test='name!=null and name!=""'>and upper(name) like '%'||upper(#{name})||'%'</if>
			<if test='phoneNumber!=null and phoneNumber!=""'>and phone_number like '%'||upper(#{phoneNumber})||'%'</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				and created_dt BETWEEN to_timestamp(#{startDate}, 'YYYY-MM-DD') AND to_timestamp(#{endDate}, 'YYYY-MM-DD') + INTERVAL '1 day' - INTERVAL '1 second'
			</if>
		</where>
		order by created_dt desc, id
	</select>
	
	<update id="resetPassword" parameterType="map">
		update tb_user
		set password = #{user_pw},
			modified_dt = now(),
			modified_id = #{login_id}
		where id = #{user_id}
	</update>
	
	<insert id="addAccount" parameterType="map">
		insert into tb_user (
			id, password, name, phone_number, due_date, hospital, user_role, remark, created_id, created_dt, modified_id, modified_dt
		)
		values (
			#{id}, #{encoded_password}, #{name}, #{phone_number}, #{due_date}, #{hospital}, 'USER', #{remark}, #{login_id}, now(), #{login_id}, now()
		)
	</insert>
	
	<update id="updateAccount" parameterType="map">
		update tb_user
		set id = #{id}, 
			name = #{name},
			phone_number = #{phone_number},
			due_date = #{due_date},
			hospital = #{hospital},
			user_status = #{user_status},
			remark = #{remark}, 
			modified_id = #{login_id}, 
			modified_dt = now() 
		where id = #{id}
	</update>

	<select id="checkId" parameterType="map" resultType="int">
		SELECT count(id)
		FROM tb_user
		WHERE 	id = #{user_id}
	</select>

</mapper>