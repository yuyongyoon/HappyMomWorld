<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.reserve.app.mapper.AdminMapper">

	<select id="getBranchNameList" parameterType="map"  resultType="map">
		SELECT tb_branch_mng.branch_code, branch_name
		FROM tb_branch_mng, tb_user
		WHERE 
			tb_branch_mng.branch_code != 'b0000'
			AND tb_user.user_role like 'SUPERADMIN'
		ORDER BY tb_branch_mng.branch_code
	</select>

	<select id="getUserList" parameterType="map" resultType="map">
		SELECT
			a.id,
			a.name,
			a.phone_number,
			a.due_date,
			a.user_role,
			a.remark,
			TO_CHAR(a.created_dt, 'YYYY-MM-DD') AS created_dt,
			a.branch_code,
			CASE
				WHEN b.has_reservation >= 1 THEN 'Y'
				ELSE 'N'
			END AS massage_reserve_cnt
		FROM tb_user a
		LEFT OUTER JOIN
			(
				SELECT user_id, branch_code, COUNT(*) AS has_reservation
				FROM tb_reservation_list
				GROUP BY user_id, branch_code) b ON a.branch_code = b.branch_code AND a.id = b.user_id
		<where>
			a.user_role LIKE 'USER'
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					AND a.branch_code = #{branch_code}
				</when>
				<otherwise>
					AND a.branch_code = #{super_branch_code}
				</otherwise>
			</choose>
			<if test='userIdOrName != null and userIdOrName != ""'>
				AND (
					UPPER(a.id) LIKE '%' || UPPER(#{userIdOrName}) || '%'
					OR UPPER(a.name) LIKE '%' || UPPER(#{userIdOrName}) || '%'
				)
			</if>
			<if test='phoneNumber!=null and phoneNumber!=""'>
				AND a.phone_number LIKE '%' || UPPER(#{phoneNumber}) || '%'
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				AND a.created_dt BETWEEN TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD') AND TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD') + INTERVAL '1 day' - INTERVAL '1 second'
			</if>
		</where>
		ORDER BY a.created_dt DESC, a.id ASC
	</select>
	
	<update id="resetPassword" parameterType="map">
		update tb_user
		set password = #{user_pw},
			modified_dt = now(),
			modified_id = #{login_id}
		where id = #{user_id}
	</update>
	
	<insert id="addAccount" parameterType="map">
		insert into tb_user (
			id, password, name, phone_number, due_date, user_role, remark, created_id, created_dt, modified_id, modified_dt, branch_code, user_status
		)
		values (
			#{id}, #{encoded_password}, #{name}, #{phone_number}, #{due_date}, 'USER', #{remark}, #{login_id}, now(), #{login_id}, now(), #{branch_code}, 'Y'
		)
	</insert>
	
	<update id="updateAccount" parameterType="map">
		update tb_user
		set id = #{id}, 
			name = #{name},
			phone_number = #{phone_number},
			due_date = #{due_date},
			user_status = #{user_status},
			remark = #{remark}, 
			modified_id = #{login_id}, 
			modified_dt = now() 
		where id = #{id}
	</update>

	<select id="checkId" parameterType="map" resultType="int">
		SELECT count(id)
		FROM tb_user
		WHERE 	id = #{id}
	</select>
	
	<!--=============== 지점 관리 ===============-->
	<select id="getBranchList" parameterType="map"  resultType="map">
		SELECT	seq_no,
				tu.id,
				tbm.branch_code as branch_code_col, 
				tbm.branch_name, 
				join_code,
				to_char(tbi.created_dt,'YYYY-MM-DD') as created_dt, 
				tbi.branch_tel,
				tbi.branch_addr,
				tbi.business_hours
		FROM tb_branch_mng tbm 
				join tb_branch_info tbi on tbm.branch_code = tbi.branch_code
				join tb_user tu on tbm.branch_code = tu.branch_code and tu.user_role = 'ADMIN' and tu.user_status = 'Y'
		<where>
			tbm.branch_code != 'b0000'
			<if test='branchCode!=null and branchCode!=""'>and tbm.branch_code like '%'|| #{branchCode} ||'%'</if>
			<if test='branchName!=null and branchName!=""'>and tbm.branch_name like '%'|| #{branchName} ||'%'</if>
			<if test='joinCode!=null and joinCode!=""'>and join_code like '%'|| #{joinCode} ||'%'</if>
		</where>
		ORDER BY tbm.branch_code;
	</select>
	
	<insert id="addBranchInfo" parameterType="map">
		insert into tb_branch_mng (
			branch_name, join_code, created_id, created_dt, modified_id, modified_dt
		)
		values (
			#{branch_name}, #{join_code}, #{login_id}, now(), #{login_id}, now()
		);
		insert into tb_branch_info (
			branch_name, branch_tel, created_id, created_dt, modified_id, modified_dt, branch_code
		)
		values (
			#{branch_name}, #{branch_tel}, #{login_id}, now(), #{login_id}, now(), 
			(select branch_code from tb_branch_mng where branch_name=#{branch_name})
		);
		insert into tb_user (
			id, password, name, user_role, user_status, phone_number, created_id, created_dt, modified_id, modified_dt, branch_code
		)
		values(
			#{id}, #{encpwd}, #{branch_name}, 'ADMIN', 'Y', #{branch_tel}, #{login_id}, now(), #{login_id}, now(),
			(select branch_code from tb_branch_mng where branch_name=#{branch_name})
		);
		insert into tb_reservation_info (
			rsv_month, created_id, created_dt, modified_id, modified_dt, branch_code
		)
		values(
			'2023-00', #{login_id}, now(), #{login_id}, now(),
			(select branch_code from tb_branch_mng where branch_name=#{branch_name})
		);
	</insert>

	
	<update id="updateBranchInfo" parameterType="map">
		update tb_branch_info
		set 
			branch_name = #{branch_name},
			branch_tel = #{branch_tel},
			branch_addr = #{branch_addr},
			business_hours = #{business_hours},
			modified_id = #{login_id},
			modified_dt = now()
		where
			branch_code = (select branch_code from tb_branch_mng where join_code=#{join_code});
		
		update tb_branch_mng
		set
			branch_name = #{branch_name},
			modified_id = #{login_id}, 
			modified_dt = now()
		where 
			branch_code = (select branch_code from tb_branch_mng where join_code=#{join_code});
			
		update tb_user
		set
			name = #{branch_name},
			phone_number = #{branch_tel},
			modified_id = #{login_id}, 
			modified_dt = now()
		where
			branch_code = (select branch_code from tb_branch_mng where join_code=#{join_code});
	</update>
	
	<delete id="deleteBranchInfo" parameterType="map">
		delete from tb_branch_mng where seq_no=#{seq_no}
	</delete>

	<select id="getReservationMasterData" parameterType="map"  resultType="map">
		SELECT
			a.branch_code,
			a.rsv_month,
			a.rsv_date,
			c.worker_num,
			a."1t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '1t') AS "1t_cnt",
			a."2t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '2t') AS "2t_cnt",
			a."3t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '3t') AS "3t_cnt",
			a."4t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '4t') AS "4t_cnt",
			a."5t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '5t') AS "5t_cnt",
			a."6t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '6t') AS "6t_cnt",
			a."7t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '7t') AS "7t_cnt",
			a."8t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '8t') AS "8t_cnt",
			a."9t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '9t') AS "9t_cnt",
			a."10t",
			COUNT(b.select_time) FILTER (WHERE b.select_time = '10t') AS "10t_cnt"
		FROM tb_reservation_master a
			JOIN tb_reservation_info c on a.rsv_month =c.rsv_month  AND a.branch_code = c.branch_code 
			LEFT OUTER JOIN tb_reservation_list b on a.branch_code = b.branch_code AND a.rsv_month = b.rsv_month AND a.rsv_date = b.rsv_date
		<where>
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					a.branch_code = #{branch_code} and a.rsv_month = #{rsv_month}
				</when>
				<otherwise>
					a.branch_code = #{super_branch_code} and a.rsv_month = #{rsv_month}
				</otherwise>
			</choose>
		</where>
		GROUP BY
			a.branch_code,
			a.rsv_month,
			a.rsv_date,
			c.worker_num
		ORDER BY
			a.rsv_month,
			a.rsv_date
	</select>

	<insert id="addReservationMasterData" parameterType="list">
		insert into tb_reservation_master (
			branch_code, rsv_month, rsv_date,
			"1t", "2t", "3t", "4t", "5t", 
			"6t", "7t", "8t", "9t", "10t", 
			created_id, created_dt, modified_id, modified_dt
		)
		values 
		<foreach collection="list" item="item" separator=",">
			(
				#{branch_code}, #{item.rsv_month}, #{item.rsv_date},
				#{item.1t}, #{item.2t}, #{item.3t}, #{item.4t}, #{item.5t},
				#{item.6t}, #{item.7t}, #{item.8t}, #{item.9t}, #{item.10t},
				#{login_id}, now(), #{login_id}, now()
			)
		</foreach>
	</insert>

	<delete id="deleteReservationMasterData" parameterType="string">
		delete from tb_reservation_master 
		where branch_code=#{branch_code} and rsv_month=#{stdMonth}
	</delete>
	
	<select id="getCntBranchReservationInfo" parameterType="map"  resultType="int">
		SELECT count(branch_code)
		FROM tb_reservation_info
		<where>
			rsv_month = #{rsv_month}
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					and branch_code = #{branch_code}
				</when>
				<otherwise>
					and branch_code = #{super_branch_code}
				</otherwise>
			</choose>
		</where>
	</select>
	
	<select id="getBranchReservationInfo" parameterType="map"  resultType="map">
		SELECT worker_num, t1_name, t2_name, t3_name, t4_name, t5_name, t6_name, t7_name, t8_name, t9_name, t10_name
		FROM tb_reservation_info
		<where>
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					AND branch_code = #{branch_code}
				</when>
				<otherwise>
					AND branch_code = #{super_branch_code}
				</otherwise>
			</choose>
		</where>
		ORDER BY rsv_month desc
		limit 1
	</select>
	
	<insert id="addbranchReservationInfo" parameterType="map">
		INSERT into tb_reservation_info (
			branch_code, rsv_month, worker_num,
			t1_name, t2_name, t3_name, t4_name, t5_name,
			t6_name, t7_name, t8_name, t9_name, t10_name,
			created_id, created_dt, modified_id, modified_dt
		)
		VALUES (
			#{branch_code}, #{rsv_month}, #{worker_num}::int,
			#{t1_name}, #{t2_name}, #{t3_name}, #{t4_name}, #{t5_name},
			#{t6_name}, #{t7_name}, #{t8_name}, #{t9_name}, #{t10_name},
			#{login_id}, now(), #{login_id}, now()
		)
	</insert>
	
	<update id="updatebranchReservationInfo" parameterType="map">
		UPDATE tb_reservation_info
		SET 
			worker_num = #{worker_num}::int,
			t1_name = #{t1_name},
			t2_name = #{t2_name},
			t3_name = #{t3_name},
			t4_name = #{t4_name},
			t5_name = #{t5_name},
			t6_name = #{t6_name},
			t7_name = #{t7_name},
			t8_name = #{t8_name},
			t9_name = #{t9_name},
			t10_name = #{t10_name},
			modified_id = #{login_id},
			modified_dt = now()
		WHERE branch_code = #{branch_code} and rsv_month = #{rsv_month}
	</update>
	
	<select id="getCalendarEvent" parameterType="map"  resultType="map">
		SELECT TO_CHAR(date_series.rsv_date, 'YYYY-MM-DD') AS rsv_date, COALESCE(reservation_cnt, 0) reservation_cnt
		FROM (
			SELECT generate_series(
				TO_DATE(#{rsv_month}, 'YYYY-MM')::DATE,
				(TO_DATE(#{rsv_month}, 'YYYY-MM') + INTERVAL '1 month' - INTERVAL '1 day')::DATE,
				INTERVAL '1 day'
			) AS rsv_date
		) date_series
		LEFT JOIN (
			select rsv_date, count(rsv_date) reservation_cnt
			from tb_reservation_list 
			<where>
				rsv_month like #{rsv_month}
				<choose>
					<when test="super_branch_code == null or super_branch_code == ''">
						and branch_code = #{branch_code}
					</when>
					<otherwise>
						and branch_code = #{super_branch_code}
					</otherwise>
				</choose>
			</where>
			group by rsv_date
		) reservations ON date_series.rsv_date = reservations.rsv_date::date
		ORDER BY date_series.rsv_date;
	</select>
	
	<select id="getSeletedDateReservationList" parameterType="map"  resultType="map">
		SELECT rsv_date, a.user_id, 
				CASE 
					WHEN a.select_time = '1t' THEN b."t1_name"
					WHEN a.select_time = '2t' THEN b."t2_name"
					WHEN a.select_time = '3t' THEN b."t3_name"
					WHEN a.select_time = '4t' THEN b."t4_name"
					WHEN a.select_time = '5t' THEN b."t5_name"
					WHEN a.select_time = '6t' THEN b."t6_name"
					WHEN a.select_time = '7t' THEN b."t7_name"
					WHEN a.select_time = '8t' THEN b."t8_name"
					WHEN a.select_time = '9t' THEN b."t9_name"
					WHEN a.select_time = '10t' THEN b."t10_name"
				END AS "reservation_time"
		FROM tb_reservation_list a
		JOIN tb_reservation_info b ON a.branch_code = b.branch_code AND a.rsv_month = b.rsv_month
		<where>
			a.rsv_date = #{rsv_date}
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					and a.branch_code = #{branch_code}
				</when>
				<otherwise>
					and a.branch_code = #{super_branch_code}
				</otherwise>
			</choose>
		</where>
	</select>
	
	<select id="getBranchPrintInfo" parameterType="map"  resultType="map">
		SELECT a.branch_name, a.branch_tel, a.branch_addr, a.business_hours, a.remark, b.join_code
		FROM tb_branch_info a
		LEFT OUTER JOIN tb_branch_mng b on a.branch_code = b.branch_code 
		<where>
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					and a.branch_code = #{branch_code}
				</when>
				<otherwise>
					and a.branch_code = #{super_branch_code}
				</otherwise>
			</choose>
		</where>
	</select>
	
	<update id="saveBranchPrintInfo" parameterType="map">
		UPDATE tb_branch_info
		SET 
			branch_name = #{branch_name},
			branch_tel = #{branch_tel},
			branch_addr = #{branch_addr},
			business_hours = #{business_hours},
			remark = #{remark},
			modified_id = #{login_id},
			modified_dt = now()
		WHERE branch_code = #{branch_code}
	</update>
	
	<select id="getReservationStatusList" parameterType="map" resultType="map">
		SELECT rsv_date, a.user_id, c."name", c.phone_number, TO_CHAR(a.created_dt, 'YYYY-MM-DD') AS created_dt,
				CASE 
					WHEN a.select_time = '1t' THEN b."t1_name"
					WHEN a.select_time = '2t' THEN b."t2_name"
					WHEN a.select_time = '3t' THEN b."t3_name"
					WHEN a.select_time = '4t' THEN b."t4_name"
					WHEN a.select_time = '5t' THEN b."t5_name"
					WHEN a.select_time = '6t' THEN b."t6_name"
					WHEN a.select_time = '7t' THEN b."t7_name"
					WHEN a.select_time = '8t' THEN b."t8_name"
					WHEN a.select_time = '9t' THEN b."t9_name"
					WHEN a.select_time = '10t' THEN b."t10_name"
				END AS "reservation_time"
		FROM tb_reservation_list a
		JOIN tb_reservation_info b ON a.branch_code = b.branch_code AND a.rsv_month = b.rsv_month
		JOIN tb_user c on a.user_id = c."id"
		<where>
			<choose>
				<when test="super_branch_code == null or super_branch_code == ''">
					AND a.branch_code = #{branch_code}
				</when>
				<otherwise>
					AND a.branch_code = #{super_branch_code}
				</otherwise>
			</choose>
			<if test='userIdOrName != null and userIdOrName != ""'>
				AND (
					UPPER(a.user_id) LIKE '%' || UPPER(#{userIdOrName}) || '%'
					OR UPPER(a.user_id) LIKE '%' || UPPER(#{userIdOrName}) || '%'
				)
			</if>
			<if test='phoneNumber!=null and phoneNumber!=""'>
				AND c.phone_number LIKE '%' || UPPER(#{phoneNumber}) || '%'
			</if>
			<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				AND rsv_date::date BETWEEN TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD') AND TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD') + INTERVAL '1 day' - INTERVAL '1 second'
			</if>
			<if test='remark != null and remark != ""'>
				AND (
					UPPER(c.remark) LIKE '%' || UPPER(#{remark}) || '%'
				)
			</if>
		</where>
		ORDER BY rsv_date
	</select>
</mapper>